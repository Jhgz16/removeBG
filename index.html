<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://*.huggingface.co https://cdn.tailwindcss.com https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval'; style-src 'self' https://cdn.tailwindcss.com 'unsafe-inline'; img-src 'self' data: blob:; connect-src 'self' https://*.huggingface.co; worker-src 'self' blob:;">
    <title>Offline Image Background Remover</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='none'/></svg>" type="image/svg+xml">
    <base href="/removeBG/">
    <script src="./react.min.js"></script>
    <script>console.log('React loaded:', !!window.React);</script>
    <script src="./react-dom.min.js"></script>
    <script>console.log('ReactDOM loaded:', !!window.ReactDOM);</script>
    <script src="./heic2any.min.js"></script>
    <script>console.log('heic2any loaded:', !!window.heic2any);</script>
    <script defer src="https://cdn.tailwindcss.com?t=1722363960"></script>
    <script type="module">
        import * as transformers from './transformers.min.js?t=1722363960';
        window.transformersPipeline = transformers.pipeline;
        window.transformersReady = true;
        console.log('Transformers.js loaded as module');
    </script>
    <script>
        // Polling check for dependencies with timeout
        function loadAppJs(attempt = 0, maxAttempts = 50) {
            if (window.React && window.ReactDOM && window.transformersReady && window.heic2any) {
                const script = document.createElement('script');
                script.src = './app.js?t=1722363960';
                script.defer = true;
                document.head.appendChild(script);
                console.log('app.js loaded dynamically');
            } else {
                if (attempt >= maxAttempts) {
                    document.getElementById('root').innerHTML = `
                        <div class="text-center text-red-500 p-4">
                            <p>Error: Failed to load required libraries after ${maxAttempts} attempts.</p>
                            <p>Please clear your browser cache, refresh the page, or check the console (F12) for details.</p>
                        </div>`;
                    console.error('Dependency load timeout:', {
                        React: !!window.React,
                        ReactDOM: !!window.ReactDOM,
                        transformersReady: !!window.transformersReady,
                        heic2any: !!window.heic2any
                    });
                    return;
                }
                console.warn('Waiting for dependencies (attempt ' + attempt + '):', {
                    React: !!window.React,
                    ReactDOM: !!window.ReactDOM,
                    transformersReady: !!window.transformersReady,
                    heic2any: !!window.heic2any
                });
                document.getElementById('root').innerHTML = `
                    <div class="text-center text-gray-600 p-4">
                        <p>Loading dependencies... Please wait.</p>
                    </div>`;
                setTimeout(() => loadAppJs(attempt + 1, maxAttempts), 100);
            }
        }
        window.addEventListener('load', () => loadAppJs());
    </script>
</head>
<body>
    <div id="root" class="min-h-screen bg-gray-100 flex items-center justify-center"></div>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const response = await fetch('./sw.js');
                    if (!response.ok) {
                        throw new Error('sw.js not found at /removeBG/sw.js. Ensure it is in the repository root.');
                    }
                    await new Promise(resolve => setTimeout(resolve, 100));
                    const reg = await navigator.serviceWorker.register('./sw.js', { scope: '/removeBG/' });
                    console.log('Service Worker registered:', reg);
                } catch (err) {
                    console.error('Service Worker registration failed:', err);
                    document.getElementById('root').innerHTML = `
                        <div class="text-center text-red-500 p-4">
                            <p>Service Worker failed to register: ${err.message}</p>
                            <p>Offline mode may be limited. Ensure sw.js is in the repository root (/removeBG/sw.js).</p>
                            <p>Check the console (F12) for details.</p>
                        </div>`;
                }
            });
        } else {
            console.warn('Service Worker not supported. Offline mode may be limited.');
            document.getElementById('root').innerHTML = `
                <div class="text-center text-red-500 p-4">
                    <p>Service Worker not supported. Offline mode may be limited.</p>
                    <p>Please use a modern browser like Chrome or Edge.</p>
                </div>`;
        }
    </script>
</body>
</html>
